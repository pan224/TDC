
## 模块说明

### 1. `line_tdc`
- 使用Carry4链构建延时链，生成原始热码。
- 每个Carry4单元延时约53ps。
- 输出`value_latch_raw`为STAGE位宽的热码。

### 2. `bubble_fix`
- 修复热码中的“气泡”（如`101`→`111`）。
- 使用滑动窗口逻辑，确保热码连续。
- 提升后续二进制转换的准确性。

### 3. `latch2bin`
- 将热码转换为二进制值。
- 采用逐层折半 + 末16位计数的方法。
- 对气泡敏感，需配合`bubble_fix`使用。

### 4. `decode`
- 双路解码模块，处理时序违例。
- 分别对`valid`和`valid_dly`两拍数据进行解码。
- 根据阈值判断是否跨码片，选择正确的输出。

### 5. `tdc_top`
- 顶层模块，集成所有子模块。
- 生成`clk_bufg`，处理`sg_start`同步。
- 输出`cs_gap`和`value_gap`。

## 关键问题与解决

### 1. 延时链启动延时
- **问题**：`sg_start`到Carry4链启动存在约977ps的延时。
- **解决**：调整STAGE=512，确保延时链覆盖两个时钟周期（5000ps）。

### 2. 时序违例与死区时间
- **问题**：`sg_start`与`clk_bufg`靠近时（大约859ps），D触发器时序违例。
- **解决**：
  - 使用双路解码（`decode`模块），分别处理`valid`和`valid_dly`。
  - 根据阈值（如267、367）判断是否跨码片，选择正确输出。

### 3. 热码气泡问题
- **问题**：延时链输出中存在气泡（如`000111101111`）。
- **解决**：增加`bubble_fix`模块，修复气泡，确保热码连续。

### 4. 时钟频率选择
- **尝试**：从`400MHz`降至`300MHz`，后改回`400MHz`。
- **结论**：`400MHz`下配合`512/4=128`级延时链可覆盖两个周期，满足测量需求。

## 仿真与测试

### 仿真工具
- Xilinx Vivado Simulator

### 关键仿真结果
- 使用`bubble_fix`后，输出与时间差呈线性关系。
- 双路解码模块有效处理时序违例，输出稳定。

### 上机测试准备
- 需校准阈值（如267、367），以判断是否跨码片。
- 后续将扩展为双通道TDC，用于测量脉宽。

## 后续计划
1. **优化资源**：尝试单路解码 + 定值拼接，减少资源消耗。
2. **脉宽测量**：使用两个TDC模块分别测量上升沿和下降沿。（或者一个模块同时测上升沿和下降沿）
3. **上位机通信**：结合以太网模块，实现与上位机的数据传输。

## 学习笔记
- 2025/09/12：初步仿真发现Carry4启动延时与锁存值异常。
- 2025/10/29：调整时钟频率与STAGE，解决部分时序问题。
- 2025/11/06：引入`bubble_fix`模块，修复热码气泡。
- 2025/11/07：实现双路解码，有效处理时序违例。
- 2025/11/11：添加了计数器用于粗时间计数，reset重置计数器。

## 参考资料
- Xilinx 7 Series FPGAs SelectIO Resources
- “Bubble-Free” Thermometer-to-Binary Decoding
- 以太网通信模块（用于后续扩展）

---
**备注**：本项目仍在调试中，部分阈值和参数需根据实际上机测试进一步校准。